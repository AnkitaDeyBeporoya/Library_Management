{% extends "base.html" %}

{% block title %}Books | Library{% endblock %}

{% block content %}

    
<style>
.btn1{
    display: inline-block;
    padding: 10px 20px;
    background-color:rgba(95, 95, 105, 1);
    color: white;
    text-decoration: none;
    border-radius: 4px;
    font-weight: bold;
    transition: background-color 0.3s;
}
.btn1:hover {
    background-color: rgba(33, 32, 32, 1);
    color: white;

}
</style>


<section class="content">
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Book Table</h3>
            </div>



  <div class="container mt-4">
    {% load static %}
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0"></h2>
        <a href="{% url 'addbook' %}" class="btn1 ">Add Book</a>
    </div>
    
    <form class="form-inline ml-3 " action="{% url 'searchbook' %}" method="GET">
      <div class="input-group input-group-sm">
        {% comment %} <input id="searchBox" name="b" class="form-control" type="search" placeholder="Search">
        <div id="searchResults" class="list-group mt-2"></div> {% endcomment %}
        {% comment %} <input id="searchbook" name="b" class="form-control form-control-navbar" type="search" placeholder="Search" aria-label="Search">
        <div class="input-group-append">
          <button class="btn btn-navbar" type="submit">
            <i class="fas fa-search ms-4"></i>
          </button> {% endcomment %}

          <input id="searchbook" name="b" class="form-control" type="search" placeholder="Search">
        </div>
      </div>
    </form>  

    










<div id="book-results" class="mt-3" aria-live="polite">
   
            <div class="card-body">
                
              <table action="/" method="GET" id="example2" class="table table-bordered table-hover">
                <thead>
                <tr>
                    <th>Book-ID</th>
                    <th>Book Name</th>
                    <th>Author Name</th>
                    <th>Book Type</th>
                    <th>Total Stock</th>
                    <th>Available</th>
                    <th>Action</th>



                </tr>
            </thead>


            <tbody id="book-table-body">
                    {% for book in books %}
                <tr>
                    <td>{{book.id}}</td>
                    <td>{{book.book_name}}</td>  
                    <td>{{book.author}}</td>
                    <td>{{book.type}}</td>
                    <td>{{book.stock}}</td>
                    <td>{{book.available}}</td>


                    <td>
                    
                            <a href="{% url 'viewbook' book.id %}" class="btn btn-sm btn-primary">
                                <i class="nav-icon fas fa-eye"></i>
                            </a>
                            <a href="{% url 'editbook' book.id %}" class="btn btn-sm btn-warning text-white">
                                <i class="nav-icon fas fa-pencil"></i>
                            </a>

                            {% if book.stock != book.available %}

                                <span data-bs-toggle="tooltip" data-bs-placement="left" 
                                title="This book has an active borrow record, cannot delete.">
                                <a href="{% url 'deletebook' book.id %}"
                                class="btn btn-sm btn-secondary disabled" 
                                tabindex="-1" aria-disabled="true">
                                <i class="nav-icon fas fa-trash"></i>
                                </a>
                            </span>

                            {% else %}
                                <a href="{% url 'deletebook' book.id %}" class="btn btn-sm btn-danger delete-btn" data-active ="false">
                                    <i class="nav-icon fas fa-trash"></i>
                                </a>
                            {% endif %}
                        </td> 

                </tr> 
            
                
                </tr> 
            {% endfor %}
            </tbody>
        </table>
       
</div>
                


    
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
  tooltipTriggerList.forEach(function (tooltipTriggerEl) {
    new bootstrap.Tooltip(tooltipTriggerEl)
  })

        document.querySelectorAll(".delete-btn").forEach(function(btn) {
            btn.addEventListener("click", function(event) {
                const isActive = this.getAttribute("data-active") === "true";
                
                if (isActive) {
                    event.preventDefault(); 
                    alert("Deletion blocked! This book has an active borrow record.");
                } 
                else {
                    const confirmDelete = confirm("Are you sure you want to delete this book?");
                    if (!confirmDelete) {
                        event.preventDefault(); 
                    }
                }
            });
        });
    });
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const searchInput = document.getElementById("searchbook");
  const tableBody = document.getElementById("book-table-body");

  searchInput.addEventListener("keyup", function () {
    let query = this.value.trim();

    fetch("{% url 'searchbook' %}?b=" + encodeURIComponent(query), {
      headers: { "X-Requested-With": "XMLHttpRequest" }
    })
      .then(res => res.json())
      .then(data => {
        tableBody.innerHTML = data.html;
      });
  });
});
</script>



{% endblock %}



{% comment %} <script>
document.addEventListener("DOMContentLoaded", function () {
  const searchBox = document.getElementById("searchBox");
  const resultsBox = document.getElementById("searchResults");

  searchBox.addEventListener("keyup", function () {
    let query = this.value.trim();
    if (query.length < 1) { 
      resultsBox.innerHTML = "";
      return;
    }

    fetch("{% url 'searchbook' %}?b=" + encodeURIComponent(query), {
      headers: { "X-Requested-With": "XMLHttpRequest" }
    })
      .then(res => res.json())
      .then(data => {
        resultsBox.innerHTML = "";
        if (data.results.length > 0) {
          data.results.forEach(item => {
            let link = document.createElement("a");
            link.href = "/books/" + item.id + "/"; 
            link.className = "list-group-item list-group-item-action";
            link.innerText = `${item.book_name} (${item.author})`;
            resultsBox.appendChild(link);
          });
        } else {
          resultsBox.innerHTML = "<div class='list-group-item'>No results</div>";
        }
      });
  });
});
</script> {% endcomment %}








{% comment %} <div class="container mt-4">
    {% load static %}

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">Books List</h2>
        <a href="{% url 'addbook' %}" class="btn1 ">Add Book</a>
    </div>

    <form action="{% url 'searchbook' %}" method="GET" class="d-flex mb-3" style="max-width: 500px; color: black;">
        <input type="text"
            name="b"
            class="form-control me-2"
            placeholder="search by book name" 
            value="{{request.GET.b}}"
            style="flex-grow: 1;"> 
            <button type="submit" class="btn1 me-2">Search</button>
            <a href="{% url 'books' %}" class="btn1">Reset</a>
        
        </form>
    </div>


<div class="container mt-5 width-80% table-responsive-md" >
        <table action="/" id="book" method="GET" class="table table-bordered table-hover align-middle text-center ">
            <thead class="table-dark">
                <tr>
                    <th>Book-ID</th>
                    <th>Book Name</th>
                    <th>Author Name</th>
                    <th>Book Type</th>
                    <th>Total Stock</th>
                    <th>Available</th>
                    <th>Action</th>



                </tr>
            </thead>


            <tbody class="">
                    {% for book in books %}
                <tr>
                    <td>{{book.id}}</td>
                    <td>{{book.book_name}}</td>  
                    <td>{{book.author}}</td>
                    <td>{{book.type}}</td>
                    <td>{{book.stock}}</td>
                    <td>{{book.available}}</td>


                    <td>
                    
                            <a href="{% url 'viewbook' book.id %}" class="btn btn-sm btn-primary">
                                <i class="nav-icon fas fa-eye"></i>
                            </a>
                            <a href="{% url 'editbook' book.id %}" class="btn btn-sm btn-warning text-white">
                                <i class="bi bi-pencil"></i>
                            </a>

                            {% if book.stock != book.available %}

                                <span data-bs-toggle="tooltip" data-bs-placement="left" 
                                title="This book has an active borrow record, cannot delete.">
                                <a href="{% url 'deletebook' book.id %}"
                                class="btn btn-sm btn-secondary disabled" 
                                tabindex="-1" aria-disabled="true">
                                <i class="bi bi-trash"></i>
                                </a>
                            </span>

                            {% else %}
                                <a href="{% url 'deletebook' book.id %}" class="btn btn-sm btn-danger delete-btn" data-active ="false">
                                    <i class="bi bi-trash"></i>
                                </a>
                            {% endif %}
                        </td> 

                </tr> 
            
                
                </tr> 
            {% endfor %}
            </tbody>
        </table>
    </div> {% endcomment %}
